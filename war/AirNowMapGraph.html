<head>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.3/jquery.js"></script>
<script src="https://raw.github.com/jamespadolsey/jQuery-Plugins/master/cross-domain-ajax/jquery.xdomainajax.js"></script>
<script type="text/javascript">

if (!Array.prototype.indexOf)
{
  Array.prototype.indexOf = function(elt /*, from*/)
  {
    var len = this.length;

    var from = Number(arguments[1]) || 0;
    from = (from < 0)
         ? Math.ceil(from)
         : Math.floor(from);
    if (from < 0)
      from += len;

    for (; from < len; from++)
    {
      if (from in this &&
          this[from] === elt)
        return from;
    }
    return -1;
  };
}

var iframe;
var loaderArea;
var zoom = 4;
var center = new google.maps.LatLng(40,-95);
var map;
function onLoad() {
	iframe = document.getElementById("graphDisplay");
	loaderArea = document.getElementById("loaderArea");
	map = new google.maps.Map(document.getElementById('map_canvas'), {
		center: center,
		zoom: zoom,
		mapTypeId: google.maps.MapTypeId.HYBRID,
		scaleControl: true,
		streetViewControl: false,
		panControl: true,
		draggable: true
	});
	var layer = new google.maps.FusionTablesLayer(1278639, {clickable: true,
						map: map,
						suppressInfoWindows: true
						});
	google.maps.event.addListener(layer, 'click', onClick);
	registerListener();
	
}

function registerListener(){
	window.setTimeout(function(){
		if (iframe.contentWindow.grapher && iframe.contentWindow.grapher.addChannelChangeListener){
			var id = iframe.contentWindow.grapher.addChannelChangeListener(onChannelAddedOrRemoved);
		}
		else{
			registerListener();
		}
	},100);	
}

var siteData = new Array();

function getSiteData(siteName){
	for (var i = 0; i < siteData.length; i++){
		if (siteData[i][0] == siteName)
			return siteData[i];
	}
	return null;
}

function deleteSiteData(siteName){
	for (var i = 0; i < siteData.length; i++){
		if (siteData[i][0] == siteName){
			var marker = siteData[i][2];
			siteData.splice(i,1);
			if (marker != null){
				marker.setMap(null);
			}
			break;
		}
	}
}


function onChannelAddedOrRemoved(deviceName,channelName,added){
	if (added){
		var sData = getSiteData(deviceName);
		if (sData == null){
			sData = new Array();
			sData[0] = deviceName;
			sData[1] = new Array();
			sData[2] = null;
			siteData.push(sData);
		}
		var channels = sData[1];
		var chanIndex = channels.indexOf(channelName);
		if (chanIndex == -1){
			chanIndex = channels.push(channelName) - 1;
			if (chanIndex == 0){ //add the marker to the map
				loadLocationAndDisplayMarker(deviceName);
			}
		}
		/*var index = curSites.indexOf(deviceName);
		if (index == -1){
			index = curSites.push(deviceName) - 1;
			curChannels.push(new Array());
		}
		var channels = curChannels[index];
		var chanIndex = channels.indexOf(channelName);
		if (chanIndex == -1){
			chanIndex = curChannels[index].push(channelName) - 1;
			if (chanIndex == 0){ //add the marker to the map
				loadLocationAndDisplayMarker(deviceName);
			}
		}*/
	}
	else{
		var sData = getSiteData(deviceName);
		if (sData != null){
			var channels = sData[1];
			var chanIndex = channels.indexOf(channelName);
			if (chanIndex != -1){
				channels.splice(chanIndex,1);
				if (channels.length == 0){
					deleteSiteData(deviceName);
				}
			}
		}
		/*var index = curSites.indexOf(deviceName);
		if (index != -1){
			var channels = curChannels[index];
			var chanIndex = channels.indexOf(channelName);
			if (chanIndex != -1){
				channels.splice(chanIndex,1);
				if (channels.length == 0){
					channels.splice(index,1);
					curSites.splice(index,1);
					markers[index].setMap(null);
					markers.splice(index,1);
				}
			}
		}*/
	}
}

function loadLocationAndDisplayMarker(deviceName){
	$.get("https://www.google.com/fusiontables/api/query?sql=SELECT%20Latitude%2C%20Longitude%20FROM%201278639%20WHERE%20formattedName%3D'" + deviceName + "'%20LIMIT%201",function(res){
		var text = res.responseText;
		var t = $(text);
		text = t[5].innerText;
		text = text.substring(19);
		var numbers = JSON.parse("[" + text + "]");
		var lat = numbers[0];
		var lon = numbers[1];
		var sData = getSiteData(deviceName);
		if (sData != null){
			var temp = new google.maps.Marker({
						map: map,
						position: new google.maps.LatLng(lat,lon)
			});
			sData = getSiteData(deviceName);
			sData[2] = temp;
			google.maps.event.addListener(temp, 'click', function(ev){
						var sData = getSiteData(deviceName);
						if (sData == null){
							temp.setMap(null);
						}
						else{
							var channels = sData[1];
							var channelscopy = new Array();
							for (var i = 0; i < channels.length; i++){
								channelscopy[i] = channels[i];
							}
							for (var i = 0; i < channelscopy.length; i++){
								iframe.contentWindow.grapher.removeChannel(deviceName, channelscopy[i]);
							}
						}
						
			});
		}	
	});
}

var shiftDown = false;
var rowArray = new Array();

function getShiftState(e){
	shiftDown = e.shiftKey;
}

function onClick(e){
	/*if (!shiftDown)
		rowArray = new Array();
	for (var i = 0; i < rowArray.length; i++){
		if (rowArray[i].formattedName.value == e.row.formattedName.value){
			rowArray.splice(i,1);
			updateIFrame();
			return;
		}
	}
	rowArray[rowArray.length] = e.row;
	updateIFrame();*/
	var channelsInfo = JSON.parse(e.row.ChannelData.value);
	var siteName = e.row.formattedName.value;
	for (var i = 0; i < channelsInfo.length; i++){
		if (iframe.contentWindow.grapher.hasChannel(siteName,channelsInfo[i][0]))
			iframe.contentWindow.grapher.removeChannel(siteName,channelsInfo[i][0]);
		else
			iframe.contentWindow.grapher.addChannelWithBounds(siteName,channelsInfo[i][0],channelsInfo[i][1],channelsInfo[i][2]);
	}
}

function updateIFrame(){
	/*if (rowArray.length == 0){
		iframe.src = "about:blank";
		return;
	}
	var ts = Math.round((new Date()).getTime() / 1000);
	var startTime = ts;
	var channelNames = "";
	var channelSpecs = "";
	var totalRows = 0;
	var baseIndex = 0;
	for (var i = 0; i < rowArray.length; i++){
		totalRows += JSON.parse(rowArray[i].ChannelData.value).length;
	}
	for (var j = 0; j < rowArray.length; j++){
		var curTime = rowArray[rowArray.length - 1 - j].startTime.value;
		var channelsInfo = JSON.parse(rowArray[rowArray.length - 1 - j].ChannelData.value);
		var siteName = rowArray[rowArray.length - 1 - j].formattedName.value;
		if (startTime > curTime)
			startTime = curTime;
		for (var i = 0; i < channelsInfo.length; i++){
			if (i != 0 || j != 0){
				channelNames += ",";
				channelSpecs += ",";
			}
			channelNames += siteName + "." + channelsInfo[i][0];
			channelSpecs += "\"" + siteName + "." + channelsInfo[i][0] + "\":{\"min_value\":";
			var min = channelsInfo[i][1];
			var max = channelsInfo[i][2];
			var spread = max - min;
			min -= spread * 0.05;
			max += spread * 0.05;
			spread = max - min;
			min -= spread * (i + baseIndex);
			max += spread * (totalRows - 1 - i - baseIndex);
			channelSpecs += min;
			channelSpecs += ",\"max_value\":" + max + "}";
		}
		baseIndex += channelsInfo.length;
	}
	iframe.src = "http://127.0.0.1:8888/Grapher2.html?init_min_time=" + startTime + "&init_max_time=" + ts + "&channel_names=[" + channelNames + "]&channel_specs={" + channelSpecs + "}";*/
}
</script>
</head>

<body style="height:100%; margin:0;" onload="onLoad();">
<div id="map_canvas" style="position:absolute; left:0; bottom:0; height:50%; width:100%; bored:none;"></div>
<iframe id="graphDisplay" src="http://127.0.0.1:8888/Grapher2.html" style="position:absolute; right:0; top:0; height:50%; width:100%; border:none"></iframe>
</body>