<head>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.3/jquery.js"></script>
<script src="https://raw.github.com/jamespadolsey/jQuery-Plugins/master/cross-domain-ajax/jquery.xdomainajax.js"></script>
<script type="text/javascript">

if (!Array.prototype.indexOf)
{
  Array.prototype.indexOf = function(elt /*, from*/)
  {
    var len = this.length;

    var from = Number(arguments[1]) || 0;
    from = (from < 0)
         ? Math.ceil(from)
         : Math.floor(from);
    if (from < 0)
      from += len;

    for (; from < len; from++)
    {
      if (from in this &&
          this[from] === elt)
        return from;
    }
    return -1;
  };
}

var iframe;
var splashScreen;
var loaderArea;
var geocoder;
var zoom = 4;
var splashSpeed = 0;
var splashPos = 1;
var center = new google.maps.LatLng(40,-95);
var map;

function onLoad() {
	var baseValue = "A".charCodeAt(0);
	for (var i = 0; i < 26; i++){
		markerImages.push(new google.maps.MarkerImage("http://maps.google.com/mapfiles/marker" + (String.fromCharCode(baseValue + i)) + ".png"));
	}
	iframe = document.getElementById("graphDisplay");
	iframe.contentWindow.jsapi = {};
	iframe.contentWindow.jsapi.getLocation = jsapiGetLocation;
	iframe.contentWindow.jsapi.getBubbleMapping = jsapiGetBubbleMapping;
	splashScreen = document.getElementById("splashScreen");
 	geocoder = new google.maps.Geocoder();
	loaderArea = document.getElementById("loaderArea");
	map = new google.maps.Map(document.getElementById('map_canvas'), {
		center: center,
		zoom: zoom,
		mapTypeId: google.maps.MapTypeId.HYBRID,
		scaleControl: true,
		streetViewControl: false,
		panControl: true,
		draggable: true
	});
	var layer = new google.maps.FusionTablesLayer(1499954, {clickable: true,
						map: map,
						suppressInfoWindows: true
						});
	google.maps.event.addListener(layer, 'click', onClick);
	registerListener();
	scrollSplash();
}

function jsapiGetLocation(deviceName, callback){
	$.get("https://www.google.com/fusiontables/api/query?sql=SELECT%20Latitude%2C%20Longitude%20FROM%201278639%20WHERE%20formattedName%3D'" + deviceName + "'%20LIMIT%201",function(res){
		var text = res.responseText;
		var t = $(text);
		text = t[5].innerText;
		text = text.substring(19);
		var numbers = JSON.parse("[" + text + "]");
		var lat = numbers[0];
		var lon = numbers[1];
		geocoder.geocode({'latLng': new google.maps.LatLng(lat,lon)}, function(results, status) {
			var locationFound = null;
			if (status == google.maps.GeocoderStatus.OK) {
				for (var i = 0; i < results.length && !locationFound; i++){
					for (var j = 0; j < results[i].types.length && !locationFound; j++){
						if (results[i].types[j] == "locality")
							locationFound = results[i].formatted_address;
					}
				}
			} else {
			}
			callback(locationFound);
		});

	});
}

function jsapiGetBubbleMapping(){
	var data = {};
	for (var i = 0; i < siteData.length; i++){
		var temp = new Array();
		var siteName = siteData[i][0];
		var charName = "A";
		var marker = siteData[i][2];
		if (marker != null){
			var index = 0;
			for (var j = 0; j < markerImages.length; j++){
				if (markerImages[j] == marker.getIcon()){
					index = j;
					break;
				}
			}
			charName = String.fromCharCode("A".charCodeAt(0) + index);
		}
		data[siteName] = charName;
	}
	return data;
}

function scrollSplash(){
	window.setTimeout(function(){
		if (splashSpeed > 0 && splashPos < 1){
			splashPos += splashSpeed;
			splashScreen.style.opacity = splashPos;
		}
		else if (splashSpeed < 0 && splashPos > 0){
			splashPos += splashSpeed;
			splashScreen.style.opacity = splashPos;
		}
		scrollSplash();
	},50);
}

function registerListener(){
	window.setTimeout(function(){
		if (iframe.contentWindow.grapher && iframe.contentWindow.grapher.addChannelChangeListener){
			var id = iframe.contentWindow.grapher.addChannelChangeListener(onChannelAddedOrRemoved);
		}
		else{
			registerListener();
		}
	},100);
}

var markerImages = new Array();

var siteData = new Array();

function getSiteData(siteName){
	for (var i = 0; i < siteData.length; i++){
		if (siteData[i][0] == siteName)
			return siteData[i];
	}
	return null;
}

function getSiteIndex(siteName){
	for (var i = 0; i < siteData.length; i++){
		if (siteData[i][0] == siteName)
			return i;
	}
	return -1;
}

function deleteSiteData(siteName){
	var adjustMarkersMode = false;
	for (var i = 0; i < siteData.length; i++){
		if (adjustMarkersMode){
			var marker = siteData[i][2];
			if (marker != null){
				marker.setIcon(markerImages[i % markerImages.length]);
			}
		}
		else if (siteData[i][0] == siteName){
			var marker = siteData[i][2];
			siteData.splice(i,1);
			if (marker != null){
				marker.setMap(null);
			}
			adjustMarkersMode = true;
			i--;
		}
	}
}


function onChannelAddedOrRemoved(deviceName,channelName,added){
	if (added){
		var sData = getSiteData(deviceName);
		if (sData == null){
			sData = new Array();
			sData[0] = deviceName;
			sData[1] = new Array();
			sData[2] = null;
			siteData.push(sData);
		}
		var channels = sData[1];
		var chanIndex = channels.indexOf(channelName);
		if (chanIndex == -1){
			chanIndex = channels.push(channelName) - 1;
			if (chanIndex == 0){ //add the marker to the map
				loadLocationAndDisplayMarker(deviceName);
			}
		}
		if (siteData.length == 1){
			splashSpeed = -0.1;
		}
	}
	else{
		var sData = getSiteData(deviceName);
		if (sData != null){
			var channels = sData[1];
			var chanIndex = channels.indexOf(channelName);
			if (chanIndex != -1){
				channels.splice(chanIndex,1);
				if (channels.length == 0){
					deleteSiteData(deviceName);
				}
			}
		}
		if (siteData.length == 0){
			splashSpeed = 0.1;
		}
	}
}

function loadLocationAndDisplayMarker(deviceName){
	$.get("https://www.google.com/fusiontables/api/query?sql=SELECT%20Latitude%2C%20Longitude%20FROM%201278639%20WHERE%20formattedName%3D'" + deviceName + "'%20LIMIT%201",function(res){
		var text = res.responseText;
		var t = $(text);
		text = t[5].innerText;
		text = text.substring(19);
		var numbers = JSON.parse("[" + text + "]");
		var lat = numbers[0];
		var lon = numbers[1];
		var sData = getSiteData(deviceName);
		if (sData != null){
			var temp = new google.maps.Marker({
						map: map,
						icon: markerImages[getSiteIndex(deviceName) % markerImages.length],
						position: new google.maps.LatLng(lat,lon)
			});
			sData = getSiteData(deviceName);
			sData[2] = temp;
			google.maps.event.addListener(temp, 'click', function(ev){
						var sData = getSiteData(deviceName);
						if (sData == null){
							temp.setMap(null);
						}
						else{
							var channels = sData[1];
							var channelscopy = new Array();
							for (var i = 0; i < channels.length; i++){
								channelscopy[i] = channels[i];
							}
							for (var i = 0; i < channelscopy.length; i++){
								iframe.contentWindow.grapher.removeChannel(deviceName, channelscopy[i]);
							}
						}
			});
		}
	});
}

var shiftDown = false;
var rowArray = new Array();

function getShiftState(e){
	shiftDown = e.shiftKey;
}

function onClick(e){
	var channelsInfo = JSON.parse(e.row.ChannelData.value);
	var siteName = e.row.formattedName.value;
	for (var i = 0; i < channelsInfo.length; i++){
		if (iframe.contentWindow.grapher.hasChannel(siteName,channelsInfo[i][0]))
			iframe.contentWindow.grapher.removeChannel(siteName,channelsInfo[i][0]);
		else
			iframe.contentWindow.grapher.addChannelWithBounds(siteName,channelsInfo[i][0],channelsInfo[i][1],channelsInfo[i][2]);
	}
}
</script>
</head>

<body style="height:100%; margin:0;" onload="onLoad();">
<div id="map_canvas" style="position:absolute; left:0; bottom:0; height:50%; width:100%; bored:none;"></div>
<div style="position:absolute; position:absolute; left:0; top:0; height:50%; width:100%; border:none;">
<div style="height:15%">Header goes here!</div>
<iframe id="graphDisplay" src="Grapher2.html" style="position: absolute;
left: 0;
top: 15%;
height: 85%;
width: 100%;
border: none;"></iframe>
</div>
<iframe id="splashScreen" src="SplashScreen.html" style="position:absolute; left:0; top:0; height:50%; width:100%; border:none; background:white;"></iframe>
</body>
